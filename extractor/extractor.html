<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Extractor de correos</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h2 { color: #333; }
    input, button { margin: 10px 0; padding: 8px; }
    button { cursor: pointer; }
  </style>
</head>
<body>
  <h2>Extractor de correos de contacto</h2>
  <p>Sube un archivo Excel (.xlsx) con una columna llamada <b>URL</b></p>
  <input type="file" id="fileInput" accept=".xlsx" />
  <button onclick="procesar()">Extraer correos</button>
  <p id="estado"></p>

  <script>
    async function procesar() {
      const fileInput = document.getElementById('fileInput');
      const estado = document.getElementById('estado');
      if (!fileInput.files.length) {
        alert("Por favor, selecciona un archivo Excel");
        return;
      }
      estado.innerText = "Procesando...";
      const data = await fileInput.files[0].arrayBuffer();
      const workbook = XLSX.read(data, { type: "array" });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet);
      for (let i = 0; i < rows.length; i++) {
        const url = rows[i].URL;
        if (!url) continue;
        try {
          const proxy = "https://api.allorigins.win/raw?url=" + encodeURIComponent(url);
          const res = await fetch(proxy);
          const html = await res.text();
          const emails = [...html.matchAll(/[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}/g)]
                          .map(m => m[0]);
          rows[i]["Correos"] = [...new Set(emails)].join("; ");
        } catch (e) {
          rows[i]["Correos"] = "";
        }
        estado.innerText = `Procesando ${i + 1} de ${rows.length}...`;
      }
      const newSheet = XLSX.utils.json_to_sheet(rows);
      const newBook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(newBook, newSheet, "Resultados");
      const wbout = XLSX.write(newBook, { bookType: "xlsx", type: "array" });
      saveAs(new Blob([wbout], { type: "application/octet-stream" }), "resultados.xlsx");
      estado.innerText = "Â¡Hecho! Archivo generado.";
    }
  </script>
</body>
</html>
